Code borrowed from Apache Beam.